// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  email         String   @unique
  password      String
  firstName     String
  lastName      String
  role          Role     @default(FREE)
  isActive      Boolean  @default(true)
  isVerified    Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relaciones
  transactions          Transaction[]
  categories            Category[]
  recurringTransactions RecurringTransaction[]

  @@map("users")
}

model VerificationCode {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  email      String
  code       String
  type       CodeType
  expiresAt  DateTime
  isUsed     Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@index([email, type, isUsed])
  @@map("verification_codes")
}


model Category {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  name         String
  color        String   @default("#3B82F6")
  icon         String   @default("üìÅ")
  isDefault    Boolean  @default(false)
  userId       String   @db.ObjectId
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relaciones
  transactions          Transaction[]
  // ‚ö†Ô∏è AGREGAR ESTA RELACI√ìN:
  recurringTransactions RecurringTransaction[] @relation("RecurringTransactionCategory")

  @@index([userId])
  @@map("categories")
}

model Transaction {
  id          String          @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  type        TransactionType
  amount      Float
  date        DateTime
  description String?
  categoryId  String          @db.ObjectId
  category    Category        @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  userId      String          @db.ObjectId
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([userId, date])
  @@index([categoryId])
  @@map("transactions")
}

model RecurringTransaction {
  id          String          @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  type        TransactionType
  amount      Float
  description String?
  categoryId  String          @db.ObjectId
  // ‚ö†Ô∏è AGREGAR ESTA RELACI√ìN:
  category    Category        @relation("RecurringTransactionCategory", fields: [categoryId], references: [id], onDelete: Restrict)
  frequency   Frequency
  startDate   DateTime
  endDate     DateTime?
  nextRun     DateTime
  isActive    Boolean         @default(true)
  userId      String          @db.ObjectId
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([userId, isActive, nextRun])
  @@index([categoryId]) // ‚ö†Ô∏è AGREGAR ESTE √çNDICE
  @@map("recurring_transactions")
}

enum Role {
  FREE
  PREMIUM
  ADMIN
}

enum CodeType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum Frequency {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}